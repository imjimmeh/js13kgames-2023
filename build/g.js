"use strict";(()=>{var a=class{constructor({name:t}){this.name=t}};var f=class extends a{constructor(e){super({name:"ControlledBy"});this.controlledBy=e}};var _=(o,t,e)=>(o+(t-o))*e,l=o=>o<1e-5&&o>-1e-5;var B=(o,t,e)=>{let r=_(o.x,t.x,e),n=_(o.y,t.y,e);return{x:r,y:n}},M=(o,t)=>({x:o.x+t.x,y:o.y+t.y}),K=(o,t)=>({x:o.x*t,y:o.y*t}),F=({x:o,y:t})=>l(o)&&l(t);var p="Movement",y=class extends a{constructor({vector:e,maxSpeed:r}){super({name:p});this.acceleration={x:0,y:0};this.velocity={x:0,y:0};this.vector=e??{x:0,y:0},this.maxSpeed=r??2}updateSpeed(){if(l(this.vector.x)&&(this.velocity.x=0,this.acceleration.x=0),l(this.vector.y)&&(this.velocity.y=0,this.acceleration.y=0),F(this.vector))return;this.acceleration=M(this.acceleration,K(this.vector,.1)),this.velocity=B(this.velocity,M(this.velocity,this.acceleration),1);let e=this.maxSpeed*-1;this.velocity.x>this.maxSpeed?this.velocity.x=this.maxSpeed:this.velocity.x<e&&(this.velocity.x=e),this.velocity.y>this.maxSpeed?this.velocity.y=this.maxSpeed:this.velocity.y<e&&(this.velocity.y=e)}};var x=class extends a{constructor({r:e,g:r,b:n,a:i}){super({name:"Colour"});this.toRgb=()=>`rgb(${this.r}, ${this.g}, ${this.b}, ${this.a})`;this.r=e,this.g=r,this.b=n,this.a=i,this.toRgb=this.toRgb.bind(this)}};var h="Position",v=class extends a{constructor({x:e,y:r}){super({name:h});this.x=e??0,this.y=r??0}};var b=class extends a{constructor({width:e,height:r}){super({name:"Size"});this.width=e,this.height=r}};function*D(){yield new x({r:255,g:0,b:0,a:255}),yield new v({x:0,y:0}),yield new b({width:200,height:200})}var c=class{getAcceptedEntities(t){return q(t,this)}},q=function*(o,t){for(let e of o)t.accepts(e)&&(yield e)};var w=class extends c{constructor(e){super();this.webgl=e}accepts(e){return e.components.has("Size")&&e.components.has(h)&&e.components.has("Colour")}init(){}update({entities:e,systems:r}){this.webgl.startDraw();for(let m of this.getAcceptedEntities(e)){let z=m.components.get("Size"),G=m.components.get(h),I=m.components.get("Colour"),$=Y(G.x,G.y,z.width,z.height);this.webgl.gl.bufferData(this.webgl.gl.ARRAY_BUFFER,$,this.webgl.gl.STATIC_DRAW),this.webgl.gl.uniform4f(this.webgl.colourLocation,I.r,I.g,I.b,1);var n=this.webgl.gl.TRIANGLES,i=0,s=6;this.webgl.gl.drawArrays(n,i,s)}}},Y=(o,t,e,r)=>{let n=o,i=o+e,s=t,m=t+r;return new Float32Array([n,s,i,s,n,m,n,m,i,s,i,m])};var S=class extends c{constructor(){super();this.keyStates=new Map;this.init=this.init.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this)}accepts(e){let r=e.components.get("ControlledBy");return r?r.controlledBy=="Player"&&e.components.has(p):!1}init(){document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp)}update({entities:e}){for(let i of this.keyStates)i[1]=="Pressed"&&this.keyStates.set(i[0],"Held");let r=this.getAxisVector("ArrowRight","ArrowLeft"),n=this.getAxisVector("ArrowUp","ArrowDown");for(let i of this.getAcceptedEntities(e)){let s=i.components.get(p);s.vector.y=n,s.vector.x=r}}getAxisVector(e,r){let n=(this.keyStates.get(e)??"Released")!="Released"?1:0,i=(this.keyStates.get(r)??"Released")!="Released"?-1:0;return n+i}onKeyDown(e){this.keyStates.set(e.key,"Pressed")}onKeyUp(e){this.keyStates.set(e.key,"Released")}};var C=class extends c{accepts(t){return t.components.has(h)&&t.components.has(p)}init(){}update({entities:t}){for(let e of this.getAcceptedEntities(t)){let r=e.components.get(h),n=e.components.get(p);n.updateSpeed(),r.x+=n.acceleration.x,r.y+=n.acceleration.y}}};var W=class{constructor(){let t=document.querySelector("canvas");if(!t)throw"Could not find canvas";this._canvas=t,this._context=this._canvas.getContext("2d")}get canvas(){return this._canvas}get context(){return this._context}init(){this._canvas.width=window.innerWidth,this._canvas.height=window.innerHeight}clearCanvas(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}},T=null,U=()=>(T||(T=new W),T);var L=class{constructor(){this.systems=[];this.entities=[];this.update=this.update.bind(this)}init(){U().init();for(let t of this.entities)t.init();for(let t of this.systems)t.init();window.requestAnimationFrame(this.update)}update(){for(let t of this.systems)t.update({entities:this.entities,systems:this.systems});console.log("ran update"),window.requestAnimationFrame(this.update)}};var E=class{constructor(){this.components=new Map}add(t){this.components.set(t.name,t)}get(t){let e=this.components.get(t);if(e)return e}has(t){return this.components.has(t)}all(){return this.components.values()}};var P=class{constructor(){this.components=new E;this.name=""}init(){for(let t of this.components.all())console.log(t);console.log("initialised",this)}};var k=o=>{let t=window.devicePixelRatio,{width:e,height:r}=o.getBoundingClientRect(),n=Math.round(e*t),i=Math.round(r*t),s=o.width!=n||o.height!=i;return s&&(o.width=n,o.height=i),s};var R=class{constructor({fragmentShader:t,vertexShader:e}){if(!t||!e)throw"Shaders must exist";this.fragmentShader=t,this.vertexShader=e}get program(){return this._program}create(t){let e=t.createProgram();if(!e)throw"Error creating program";if(t.attachShader(e,this.vertexShader.compileShader(t)),t.attachShader(e,this.fragmentShader.compileShader(t)),t.linkProgram(e),t.getProgramParameter(e,t.LINK_STATUS))return this._program=e,e;let r=t.getProgramInfoLog(e);throw t.deleteProgram(e),r}};var V={Position:"a_position",Resolution:"u_resolution",Colour:"u_colour"};var d=class{constructor({source:t,type:e}){if(!t)throw"Source cannot be null";if(!e)throw"Type cannot be null";this.source=t,this.type=e}get compiledShader(){return this._compiledShader}compileShader(t){let e=t.createShader(this.type);if(!e)throw"Error creating shader";if(t.shaderSource(e,this.source),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS))return this._compiledShader=e,e;let r=t.getShaderInfoLog(e);throw t.deleteShader(e),r}};var j=`#version 300 es
     
// fragment shaders don't have a default precision so we need
// to pick one. highp is a good default. It means "high precision"
precision highp float;
 
uniform vec4 u_colour;

// we need to declare an output for the fragment shader
out vec4 outColour;
 
void main() {
  // Just set the output to a constant reddish-purple
  outColour = u_colour;
}`,H=new d({source:j,type:35632});var X=`#version 300 es
 
// an attribute is an input (in) to a vertex shader.
// It will receive data from a buffer
in vec2 a_position;
 
uniform vec2 u_resolution; 
// all shaders have a main function
void main() {
  // convert the position from pixels to 0.0 to 1.0
  vec2 zeroToOne = a_position / u_resolution;

  // convert from 0->1 to 0->2
  vec2 zeroToTwo = zeroToOne * 2.0;

  // convert from 0->2 to -1->+1 (clip space)
  vec2 clipSpace = zeroToTwo - 1.0;

  // gl_Position is a special variable a vertex shader
  // is responsible for setting
  gl_Position = vec4(clipSpace, 0, 1);
}`,N=new d({source:X,type:35633});var A=class{constructor({canvas:t}){this.canvas=t;let e=t.getContext("webgl2");if(!e)throw"Could not find WebGL2 context";this.gl=e,this.program=new R({fragmentShader:H,vertexShader:N}),this.program.create(this.gl)}init(){let t=this.program.program;this.getPositionLocation(t),this.getResolutionLocation(t),this.getColourLocation(t);let e=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e)}startDraw(){let t=this.gl.createVertexArray();this.gl.bindVertexArray(t),this.gl.enableVertexAttribArray(this.positionLocation);let e=2,r=this.gl.FLOAT,n=!1,i=0,s=0;this.gl.vertexAttribPointer(this.positionLocation,e,r,n,i,s),k(this.gl.canvas),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(this.program.program),this.gl.uniform2f(this.resolutionLocation,this.gl.canvas.width,this.gl.canvas.height),this.gl.bindVertexArray(t)}getResolutionLocation(t){if(this.resolutionLocation=this.gl.getUniformLocation(t,V.Resolution)??void 0,!this.resolutionLocation)throw"Could not get resolution location"}getColourLocation(t){if(this.colourLocation=this.gl.getUniformLocation(t,V.Colour)??void 0,!this.colourLocation)throw"Could not find colour uniform"}getPositionLocation(t){if(this.positionLocation=this.gl.getAttribLocation(t,V.Position),this.positionLocation<0)throw"Could not find position attribute"}};var O=document.getElementById("canvas");if(!O)throw"Couldn;'t find canvas";var Z=new A({canvas:O});Z.init();var u=new P;u.name="Player";for(let o of D())u.components.add(o);u.components.add(new y({}));u.components.add(new f("Player"));var g=new L;g.entities.push(u);g.systems.push(new S);g.systems.push(new C);g.systems.push(new w(Z));g.init();})();
//# sourceMappingURL=g.js.map
